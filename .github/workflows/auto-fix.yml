name: ğŸ¤– Auto-Fix Common Issues

on:
  workflow_dispatch:
    inputs:
      fix_type:
        description: 'Type of fix to apply'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - linting
          - dependencies
          - formatting
          - security

  schedule:
    # Run weekly maintenance on Sundays at 2 AM
    - cron: '0 2 * * 0'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-fix:
    name: ğŸ”§ Automated Maintenance
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: âš™ï¸ Set up Node.js 22.x
        uses: actions/setup-node@v4.4.0
        with:
          node-version: 22.x
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§¹ Auto-fix linting and formatting
        if: github.event.inputs.fix_type == 'all' || github.event.inputs.fix_type == 'linting' || github.event.inputs.fix_type == 'formatting'
        run: |
          echo "ğŸ§¹ Running auto-fix for linting and formatting..."

          # Save current state
          git stash push -m "Pre-autofix state" || true

          # Apply fixes
          npm run lint:eslint:fix || true
          npm run format || true

          # Check for changes
          if ! git diff --quiet; then
            echo "âœ… Applied auto-fixes"
            echo "LINTING_FIXED=true" >> $GITHUB_ENV
          else
            echo "â„¹ï¸ No linting issues to fix"
            echo "LINTING_FIXED=false" >> $GITHUB_ENV
          fi

      - name: ğŸ”’ Security updates
        if: github.event.inputs.fix_type == 'all' || github.event.inputs.fix_type == 'security'
        run: |
          echo "ğŸ”’ Checking for security updates..."

          # Check for vulnerabilities
          if npm audit --audit-level=moderate; then
            echo "âœ… No security vulnerabilities found"
            echo "SECURITY_FIXED=false" >> $GITHUB_ENV
          else
            echo "ğŸ”§ Applying security fixes..."
            npm audit fix --force || true
            
            if ! git diff --quiet package*.json; then
              echo "âœ… Applied security fixes"
              echo "SECURITY_FIXED=true" >> $GITHUB_ENV
            else
              echo "â„¹ï¸ No security fixes applied"
              echo "SECURITY_FIXED=false" >> $GITHUB_ENV
            fi
          fi

      - name: ğŸ“¦ Update dependencies
        if: github.event.inputs.fix_type == 'all' || github.event.inputs.fix_type == 'dependencies'
        run: |
          echo "ğŸ“¦ Checking for dependency updates..."
          
          # Check for outdated packages (excluding major versions)
          npm outdated --json > outdated.json || true
          
          if [ -s outdated.json ]; then
            echo "ğŸ“¦ Found outdated dependencies"
            # Update patch and minor versions only
            npx npm-check-updates -u --target minor || true
            npm install || true
            
            if ! git diff --quiet package*.json; then
              echo "âœ… Updated dependencies"
              echo "DEPS_UPDATED=true" >> $GITHUB_ENV
            else
              echo "â„¹ï¸ No dependency updates available"
              echo "DEPS_UPDATED=false" >> $GITHUB_ENV
            fi
          else
            echo "âœ… All dependencies are up to date"
            echo "DEPS_UPDATED=false" >> $GITHUB_ENV
          fi
          
          rm -f outdated.json

      - name: ğŸ§ª Validate changes
        if: contains(github.env, 'LINTING_FIXED=true') || contains(github.env, 'SECURITY_FIXED=true') || contains(github.env, 'DEPS_UPDATED=true')
        run: |
          echo "ğŸ§ª Validating all changes..."
          
          # Run validation pipeline
          npm run validate
          
          if [ $? -eq 0 ]; then
            echo "âœ… All validations passed"
            echo "VALIDATION_PASSED=true" >> $GITHUB_ENV
          else
            echo "âŒ Validation failed, reverting changes"
            git reset --hard HEAD
            git clean -fd
            echo "VALIDATION_PASSED=false" >> $GITHUB_ENV
            exit 1
          fi

      - name: ğŸ“ Generate change summary
        if: contains(github.env, 'VALIDATION_PASSED=true')
        id: changes
        run: |
          echo "ğŸ“ Generating change summary..."
          
          SUMMARY=""
          if [ "$LINTING_FIXED" = "true" ]; then
            SUMMARY="$SUMMARY\n- ğŸ§¹ Applied ESLint and Prettier fixes"
          fi
          if [ "$SECURITY_FIXED" = "true" ]; then
            SUMMARY="$SUMMARY\n- ğŸ”’ Applied security updates"
          fi
          if [ "$DEPS_UPDATED" = "true" ]; then
            SUMMARY="$SUMMARY\n- ğŸ“¦ Updated dependencies"
          fi
          
          if [ -n "$SUMMARY" ]; then
            echo "HAS_CHANGES=true" >> $GITHUB_OUTPUT
            echo "SUMMARY<<EOF" >> $GITHUB_OUTPUT
            echo -e "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "HAS_CHANGES=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸš€ Commit and push changes
        if: steps.changes.outputs.HAS_CHANGES == 'true'
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "ğŸ¤– Auto-maintenance: Weekly fixes and updates

          ${{ steps.changes.outputs.SUMMARY }}

          - ğŸ”„ Automated by GitHub Actions (scheduled)
          - âœ… All validations passed
          - ğŸ“… Run on: $(date +'%Y-%m-%d %H:%M:%S UTC')

          [skip ci]"
          git push

      - name: ğŸ“Š Report results
        if: always()
        run: |
          echo "ğŸ“Š Auto-fix Results Summary:"
          echo "ğŸ§¹ Linting fixes applied: ${LINTING_FIXED:-false}"
          echo "ğŸ”’ Security fixes applied: ${SECURITY_FIXED:-false}"
          echo "ğŸ“¦ Dependencies updated: ${DEPS_UPDATED:-false}"
          echo "âœ… Validation passed: ${VALIDATION_PASSED:-false}"
          
          if [ "${{ steps.changes.outputs.HAS_CHANGES }}" = "true" ]; then
            echo "ğŸ‰ Auto-maintenance completed successfully!"
          else
            echo "â„¹ï¸ No changes were needed"
          fi
