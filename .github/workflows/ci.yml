name: ğŸš€ CI/CD - Build & Validate (Cloudflare Pages Deploy)

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.editorconfig'
      - '.gitignore'
      - 'docs/**'
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.editorconfig'
      - '.gitignore'
      - 'docs/**'
  workflow_dispatch:

permissions:
  contents: write # Permitir commits y push

jobs:
  # ğŸ§ª Testing & Quality Assurance
  test-and-validate:
    name: ğŸ” Quality Assurance
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5.0.0

      - name: âš™ï¸ Set up Node.js 22.x
        uses: actions/setup-node@v4.4.0
        with:
          node-version: 22.x

      - name: ğŸš€ Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ” TypeScript validation
        run: |
          echo "ğŸ” Running TypeScript check..."
          bun run type-check
          echo "âœ… TypeScript validation passed!"

      - name: ğŸ§¹ Biome code quality
        run: |
          echo "ğŸ§¹ Running Biome linting..."
          bun run lint
          echo "âœ… Code quality check completed!"

      - name: ğŸ’„ Biome formatting check
        run: |
          echo "ğŸ’„ Checking code formatting..."
          bun run format:check
          echo "âœ… Code formatting is consistent!"

      - name: ğŸ—ï¸ Build validation
        run: |
          echo "ğŸ—ï¸ Building project..."
          bun run build
          echo "âœ… Build completed successfully!"

      - name: ğŸ“Š Build metrics
        run: |
          echo "ğŸ“Š Build Metrics:"
          echo "ğŸ“ Build output size:"
          du -sh dist/
          echo "ğŸ“„ Generated pages:"
          find dist -name "*.html" | wc -l | xargs echo "HTML files:"
          echo "ğŸ¨ CSS files:"
          find dist -name "*.css" | wc -l | xargs echo "CSS files:"
          echo "âš¡ JS files:"
          find dist -name "*.js" | wc -l | xargs echo "JS files:"

  # ğŸ”§ Auto-fix workflow (runs only on test failures)
  auto-fix:
    name: ğŸ¤– Auto-fix Issues
    runs-on: ubuntu-latest
    needs: test-and-validate
    if: failure() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: âš™ï¸ Set up Node.js 22.x
        uses: actions/setup-node@v4.4.0
        with:
          node-version: 22.x

      - name: ğŸš€ Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ”§ Auto-fix Biome issues
        run: |
          echo "ğŸ”§ Attempting to auto-fix Biome issues..."
          bun run lint:fix || true
          echo "âœ… Biome auto-fix completed!"

      - name: ğŸ¨ Auto-format with Biome
        run: |
          echo "ğŸ¨ Auto-formatting code with Biome..."
          bun run format
          echo "âœ… Biome formatting completed!"

      - name: ğŸ“ Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected after auto-fix"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes after auto-fix"
          fi

      - name: ğŸš€ Commit and push auto-fixes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          git commit -m "ğŸ¤– Auto-fix: Biome linting and formatting

          - ğŸ§¹ Applied Biome auto-fixes
          - ğŸ’„ Applied Biome formatting
          - ğŸ”„ Automated by GitHub Actions

          [skip ci]"
          git push

      - name: âœ… Re-run validation after auto-fix
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          echo "ğŸ”„ Re-running validation after auto-fix..."
          bun run validate
          echo "âœ… Validation passed after auto-fix!"

  # ğŸ“ˆ Build Verification (only after successful tests)
  build-verification:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    needs: test-and-validate
    if: success()
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v5.0.0

      - name: âš™ï¸ Set up Node.js 22.x
        uses: actions/setup-node@v4.4.0
        with:
          node-version: 22.x

      - name: ğŸš€ Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: bun install --frozen-lockfile

      - name: ğŸ—ï¸ Production build
        run: |
          echo "ğŸ—ï¸ Creating production build..."
          npm run build:prod
          echo "âœ… Production build completed!"

      - name: ğŸ“Š Performance analysis
        run: |
          echo "ğŸ“Š Analyzing build performance..."
          echo "ğŸ“ Total build size:"
          du -sh dist/
          echo "ğŸ—‚ï¸ File breakdown:"
          find dist -type f -exec ls -lh {} \; | awk '{print $5 " " $9}' | sort -hr | head -20
          echo "âš¡ Bundle analysis complete!"

      - name: ğŸ¯ Build artifacts summary
        run: |
          echo "ğŸ¯ Build Summary:"
          echo "ğŸ“„ HTML pages: $(find dist -name '*.html' | wc -l)"
          echo "ğŸ¨ CSS files: $(find dist -name '*.css' | wc -l)"
          echo "âš¡ JS files: $(find dist -name '*.js' | wc -l)"
          echo "ğŸ–¼ï¸ Images: $(find dist -name '*.png' -o -name '*.jpg' -o -name '*.jpeg' -o -name '*.svg' -o -name '*.webp' | wc -l)"
          echo "ğŸ“¦ Other assets: $(find dist -type f ! -name '*.html' ! -name '*.css' ! -name '*.js' ! -name '*.png' ! -name '*.jpg' ! -name '*.jpeg' ! -name '*.svg' ! -name '*.webp' | wc -l)"
